<!doctype html><html lang=en><head><title>Artnoi.com - Encrypted SSD-friendly storge on Linux using Btrfs</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content="artnoi,Prem Phansuriyanon"><meta name=author content="@artnoi"><meta charset=UTF-8><link href=/style.css rel=stylesheet><script src=/script.js></script></head><body><ul class=navbar id=navbar><li><a href=/><img src=/toplogo.png alt=Artnoi.com class=logo>artnoi</a></li><li class=f-right><a href=https://notes.artnoi.com/#/all-pages>logseq</a></li><li class=f-right><a href=/cheat/>cheat</a></li><li class=f-right><a href=/blog/>blog</a></li></ul><p>Aug 18, <a href=/blog/2019/>2019</a></p><p>Added Btrfs part Mar, <a href=/blog/2021/>2021</a></p><h1 id=encrypted-ssd-friendly-storge-on-linux-using-btrfs>Encrypted SSD-friendly storge on Linux using Btrfs</h1><h2 id=introduction>Introduction</h2><p>Hi guys. I wrote this to help some friends set up encrypted and high performance Linux data storage on SSDs. The building block is the Linux kernel, LUKS (dm-crypt) for encryption, and Btrfs for data storage and snapshots.</p><blockquote><p>This article is <strong>not about LVM</strong>, whole-disk encryption, and not booting to encrypted root filesystems, <a href=/cheat/device-mapper/>which you can read about here</a>.</p></blockquote><p>This article is written in 2 parts, (1) LUKS on Linux, and (2) Btrfs filesystem</p><h2 id=luks-linux-unified-key-setup><strong>LUKS (Linux Unified Key Setup)</strong></h2><p><a href=https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup:%22>LUKS</a> is disk encryption specification for the Linux kernel. It has many use case, e.g. whole disk encryption and partition encryption. Today we are going to do a simple disk encryption on a disk partition.</p><p>LUKS by itself is not a filesystem, so this article must mention a filesystem to make it practical for everyday use, and that is why I will mention Btrfs and EXT4, both of which are native Linux filesystems.</p><h2 id=btrfs>Btrfs</h2><p><a href=https://btrfs.wiki.kernel.org/index.php/Main_Page>Btrfs</a> is a modern filesystem for the Linux kernel. It is currently in active development, and most people seem to be divided into 3 groups: (1) those who love it, (2) those who hate it, and (3) those who don&rsquo;t care about it. Of all the features Btrfs has, it can not do encryption.</p><p>This is why I always think of LUKS when talking about Btrfs, because modern storage should always be encrypted.</p><h2 id=set-up-luks-or-luks-on-lvm-or-lvm-on-luks-cheat-device-mapper-first>Set up LUKS or <a href=/cheat/device-mapper/>LUKS-on-LVM, or LVM-on-LUKS</a> first</h2><h3 id=luks-prerequisites>LUKS: prerequisites</h3><p>The command we need to create and manage LUKS is <code>cryptsetup</code>. Most GNU/Linux distributions already ship with <code>cryptsetup</code>. You may be able to use your package manager to install it for you if it&rsquo;s not installed.</p><p>We will also need a disk partition. Use <code>fdisk</code> or <code>cfdisk</code> or any partition editor to create disk partitions for our LUKS:</p><pre><code class=language-shell>fdisk /dev/sdX;
</code></pre><h2 id=luks-formatting>LUKS Formatting</h2><p>Use <code>lsblk</code> to get block device name for your fresh GPT partition, in my case it is the 4th partition on storage device &ldquo;<em>a</em>&rdquo;, <code>/dev/sda4</code>. Then, issue:</p><pre><code class=language-shell>cryptsetup luksFormat --verify-passphrase -v /dev/sda4;
</code></pre><p>Note that <code>cryptsetup</code> <strong>command is case-sensitive</strong>. You will then be prompted if you are sure to destroy everything on the partition. After typing uppercase YES, you will be prompted for passphrase which will be used as encryption key.</p><h2 id=opening-decrypting-luks-partition>Opening (decrypting) LUKS partition</h2><p>Now that our <code>/dev/sda4</code> has been encrypted, we can decrypt it using:</p><pre><code class=language-shell>cryptsetup luksOpen /dev/sda4 myluks;
</code></pre><p>Where <code>myluks</code> is our decrypted device name in <code>/dev/mapper</code>, i.e. <code>/dev/sda4</code> is now decrypted and mapped to <code>/dev/mapper/myluks</code>. You can supply any name for mapper device name.</p><h3 id=creating-and-mounting-the-encrypted-ext4-filesystem>Creating and mounting the encrypted EXT4 filesystem</h3><p>This is only required for the first time you set up an encrypted partition, because although we have <code>/dev/mapper/enc</code>, it does not have a filesystem yet. We can create an EXT4 filesystem on the device mapper using simple <code>mkfs</code> command:</p><pre><code class=language-shell>mkfs.ext4 /dev/mapper/myluks;
</code></pre><p>Or Btrfs:</p><pre><code class=language-shell>mkfs.btrfs /dev/mapper/myluks;
</code></pre><p>After the filesystem is created, we mount the device mapper just as you would do with other filesystems:</p><pre><code class=language-shell>mount /dev/mapper/myluks /mnt;
</code></pre><p>See also: <a href=/cheat/device-mapper/>More about Device Mapper, LUKS and LVM</a></p><h2 id=btrfs-1>Btrfs</h2><p>Btrfs is a modern filesystem, featuring <strong>Copy-on-Write (CoW)</strong>, <strong>snapshots</strong>, <strong>compression</strong>, <strong>flash storage-friendly</strong>, and many other features. Btfs currently has no encryption support, but we can always use Linux <code>dm-crypt</code> to enable encryption on block storage.</p><p>When using SSDs with Btrfs, I usually set the following options in <code>fstab(5)</code>: <code>rw,compress=zstd,noatime,discard,ssd,space_cache,..</code></p><p>To enable encryption, mount the filesystem with option <code>compress=</code><em>algo</em> where <em>algo</em> is compression algorithm (zstd, zlib, lzo). If you mounted your LUKS-encrypted Btrfs as per the guide above, unmount and mount it again.</p><p>An example <code>mount</code> command to enable compression is this command with <code>zstd</code> algorithm:</p><pre><code class=language-shell>mount -t btrfs -o compress=zstd /dev/mapper/mybtrfs /mnt;
</code></pre><p>will compress new data that is written to out Btrfs (existing data is not recompressed).</p><p>This not only improves I/O performance, but also conserves SSD limited write cycles. In addition to that, Btrfs is also aware that the block storage is on SSD, even when on LUKS and LVM, and its behavior changes to work better on SSD.</p><p>This is why Btrfs is my go-to when it comes to root filesystems. Although I still use ZFS for data storage and snapshotting (and <a href=/cheat/zfs/>sending snapshots lol</a>).</p><p>ZFS command syntax is also much more practical and memorable, which makes using ZFS weirdly intuitive and <em>fun</em> - but I digress.</p><p>To compress the entire Btrfs filesystem, <strong>first mount the Btrfs partition with <code>compress=</code><em>algo</em></strong>, then use <code>filesystem defragment</code> command with compression option <code>-c</code><em>algo</em>:</p><pre><code class=language-shell>btrfs filesystem defragment -r -v -czstd;
</code></pre><p>Will use <code>zstd(1)</code> to compress files stored in the Btfs filesystem sitting on <code>/dev/mapper/mybtrfs</code> device.</p><blockquote><p>Note that <code>zstd</code> is most recent compression added to Btrfs. My laptop main root partition (which is everything incl. <code>/home</code>, but excl. data on ZFS) shrank from 4-ish GB in size to ~1.8GB with zstd compression!</p></blockquote><p>With 2GB root filesystem, my 512GB SSD is going to outlast my computer useful life lol.</p><hr><p><a href=#top>Back to top</a></p><hr><footer><p>Copyright (c) 2019 Prem Phansuriyanon</p><p>Verbatim copying and redistribution of this entire page are permitted provided this notice is preserved</p></footer></body></html>